<!DOCTYPE html>
<html lang="fr">

<head>
  <title>SAE2.03 APP</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/base.css" />
</head>

<body>
  <header id="header"></header>
  <section id="content">
    <section id="movies__body"></section>
  </section>
  <section id="detail"></section>
  <script type="module">

    import { NavBar } from "./component/NavBar/script.js";
    import { Movie } from "./component/Movie/script.js";
    import { Detail } from "./component/Detail/script.js";
    import { MovieCategory } from "./component/MovieCategory/script.js"

    import { DataMovie } from './data/dataMovie.js';
    import { DataProfile } from './data/dataProfile.js';
 
    // Controleur
    // Rappel, écrire window.C plutôt que let C est nécessaire pour tester depuis la console du navigateur
    // Une fois l'application terminée, on pourrait remettre let C.
    window.C = {};

    C.handlerAbout = function () {
      alert(
        "Ceci est une base de projet pour la SAE2.03 édition 2025. Bonne chance connard!"
      );
    };



    C.handlerDetail = async function (movieId) {
    console.log("Movie ID passed to handlerDetail:", movieId);
    let movieData = await DataMovie.detailMovie(movieId);
    V.renderDetail(movieData);
};
    C.handlerReverse = function () {
        const detailElement = document.querySelector("#big_parent");
        if (detailElement) {
            detailElement.classList.toggle("hidden");
            console.log("Le composant #detail a disparu");
        } else {
            console.log("Element with ID #detail not found");
        }
    };

    C.handlerProfile = async function () {
        const select = document.querySelector("#profile-select");
        let dataProfile = await DataProfile.readOne(select.value);
        C.profile = dataProfile[0];
      //  C.getMovie(C.profile.min_age);
      };

      C.setProfileImage = function (imageName) {
      const profileImage = document.querySelector("#profile-picture");
      const defaultImage =
        "../server/images/default.avif"; // Chemin de l'image par défaut

      // Construit l'Name complète de l'image ou utilise l'image par défaut si newImage est vide
      profileImage.src = imageName
        ? `../server/images/${imageName}`
        : defaultImage;

    }

    C.getMovie = async function () {
  let allMovies = await DataMovie.getMovie();
  V.renderMovie();
};


//#########################################################################################################################

function calculateAge(dob) {
    const today = new Date(); // La date d'aujourd'hui
    const birthDate = new Date(dob); // La date de naissance
    let age = today.getFullYear() - birthDate.getFullYear(); // Années de différence
    const monthDiff = today.getMonth() - birthDate.getMonth();
    // Ajustement si l'anniversaire de cette année n'est pas encore passé
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}


C.handlerProfileChange = async function() {
    const select = document.getElementById('profile-select');
    const avatarImg = document.getElementById('profile-picture');

    if (!select || !avatarImg) {
        console.error("Éléments HTML non trouvés");
        return;
    }

    const baseURL = "https://mmi.unilim.fr/~villoutreix8/SAE2.03-NinoVilloutreix/server/images/";
    const defaultImage = baseURL + "default.avif";

    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption) {
        if (selectedOption.value === "") {
            avatarImg.classList.add('hidden');
        } else {
            const avatarPath = selectedOption.getAttribute('data-avatar');
            avatarImg.src = avatarPath ? baseURL + avatarPath : defaultImage;
            avatarImg.classList.remove('hidden');

            // Récupération de la date de naissance
            const dob = selectedOption.getAttribute('data-age');
            if (dob) {
                const age = calculateAge(dob); // Conversion de la date en âge
                console.log("Âge calculé :", age);

                // Recharger les films avec la limite d'âge
                await C.getMovieCategory(age);
            } else {
                console.warn("Aucune date de naissance trouvée !");
                await C.getMovieCategory(null); // Aucun filtre
            }
        }
    }
};



//#########################################################################################################################

    C.start = async function () {
      let profiles = await DataProfile.read();
      V.renderNavBar("C.handlerAbout()",profiles);
      // let movies = await DataMovie.getMovie();
      // let categories = await DataMovie.getCategory();
      
      // if (movies.length == 0) {
      //   movies = [
      //     {
      //       image: "placeholder.jpg",
      //       name: "Pas de film disponibles pour le moment"
      //     }
      //   ]
      // }
      // V.renderMovie(movies)
      // V.renderMovieCategory(movies);
      C.getMovieCategory();
      C.setProfileImage();
    };


    C.getMovieCategory = async function(profileAge = null) {
    let categories = await DataMovie.getCategory();
    let html = await MovieCategory.formatMany(categories, profileAge);
    V.renderMovieCategory(html);
};

    


    // Vue (contient tout ce qui est relatif à l'affichage)
    window.V = {};

    /**
     * V.renderNavBar
     *
     * Cette fonction est responsable de l'affichage de la barre de navigation (NavBar).
     * Elle sélectionne l'élément HTML avec l'ID "header" et y insère le contenu
     * formaté par le composant NavBar.
     */
    V.renderNavBar = function (hAbout, profiles) {
      let header = document.querySelector("#header");
      header.innerHTML = NavBar.format(hAbout, profiles);
    };



    V.renderMovie = async function (m) {
  let content = document.querySelector("#content");
  content.innerHTML = ""; // Vide l'ancien contenu !
  m.forEach((movie) => {
    let cardHTML = Movie.format(movie);
    content.innerHTML += cardHTML;
  });
};

    V.renderDetail = async function (handlerDetail) {
      let content = document.querySelector("#detail");
      let detailHTML = Detail.format(handlerDetail);
      content.innerHTML = detailHTML; // Insère le contenu dans le DOM
    };

    V.reverseDetail = async function (handlerReverse) {
      let content = document.querySelector("#detail");
      let detailHTML = Detail.format(handlerReverse);
      content.innerHTML = detailHTML; // Retire le contenu du DOM... je crois??
    };

    V.renderMovieCategory = async function (html) {
    let content = document.querySelector("#movies__body");
    content.innerHTML = html;
};

    C.start(); // Démarre l'application









//https://mmi.unilim.fr/~villoutreix8/SAE2.03-NinoVilloutreix/server/script.php?todo=readmoviecategories&id=1&date=16 ÇA MARCHE ÇA


  </script>
</body>

</html>
<script type="module"></script>


